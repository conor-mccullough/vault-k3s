#output: {all: '|tee -a /var/log/cloud-init-output.log'} # Stored in the VM

#packages:
#  - gpg
#  - unzip
#  - docker
#  - docker-compose
#package_update: true
#package_upgrade: true
#package_reboot_if_required: false

runcmd:
#  - sudo useradd -r boundary
#  - adduser --system --group boundary || true
  - mkdir /opt/boundary
  - curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.24.7+k3s1 sh -
  - mkdir -p /home/ubuntu/.kube/
#  - cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
#  - chown ubuntu:ubuntu /home/ubuntu/.kube/config
#  - k3s completion bash > /etc/bash_completion.d/k3s
#  - echo "export KUBECONFIG=/home/ubuntu/.kube/config" | tee -a /home/ubuntu/.bashrc
#  - echo "alias k=\'kubectl\'" | tee -a /home/ubuntu/.bashrc

#  - sudo apt install jq -y 
#  - sudo apt install gpg -y
#  - sudo apt install unzip -y
#  - sudo snap install docker
#  - sudo snap install docker-compose

  - wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
  - echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
  - wget https://releases.hashicorp.com/boundary-worker/0.12.1+hcp/boundary-worker_0.12.1+hcp_linux_arm64.zip
  - unzip boundary-worker_0.12.1+hcp_linux_arm64.zip
  - cp boundary-worker /usr/local/bin/boundary
#  - sudo apt update && sudo apt install boundary-enterprise
#  - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
#  - helm completion bash > /etc/bash_completion.d/helm
#  - runuser -l ubuntu -c "helm repo add hashicorp https://helm.releases.hashicorp.com"

#  - chown boundary:boundary /opt/boundary
#  - chown boundary:boundary /usr/local/bin/boundary
#  - kubectl completion bash > /etc/bash_completion.d/kubectl

# Using Ubuntu user because cloud-init runs through things in a weird order and setting this to boundary:boundary causes it to fail
# See https://git.launchpad.net/cloud-init/tree/config/cloud.cfg.tmpl for precedence (init > config)

groups:
  - boundary

users:
  - name: boundary
    groups: boundary
    system: true

write_files:
- path: /etc/systemd/system/boundary.service
  content: |
    [Unit]
    Description="boundary"
    Requires=network-online.target
    After=network-online.target
    ConditionFileNotEmpty=/opt/boundary/boundary.hcl
    [Service]
    User=boundary
    Group=boundary
    PIDFile=/var/run/boundary/boundary.pid
    ExecStart=/usr/local/bin/boundary server -config=/opt/boundary/boundary.hcl
    StandardOutput=file:/var/log/boundary/boundary.log
    StandardError=file:/var/log/boundary/boundary.log
    ExecReload=/bin/kill -HUP $MAINPID
    KillMode=process
    KillSignal=SIGINT
    Restart=on-failure
    RestartSec=42
    TimeoutStopSec=30
    StartLimitInterval=60
    StartLimitBurst=3
    LimitMEMLOCK=infinity
    [Install]
    WantedBy=multi-user.target
  permissions: '0644'
  defer: true
- path: /etc/systemd/system/boundary-worker.service
  content: |
    [Unit]
    Description="boundary-worker"
    Requires=network-online.target
    After=network-online.target
    ConditionFileNotEmpty=/opt/boundary/boundary.hcl
    [Service]
    User=boundary
    Group=boundary
    PIDFile=/var/run/boundary/boundary.pid
    ExecStart=/usr/local/bin/boundary server -config=/opt/boundary/boundary.hcl -log-level=trace
    StandardOutput=file:/var/log/boundary/boundary.log
    StandardError=file:/var/log/boundary/boundary.log
    ExecReload=/bin/kill -HUP $MAINPID
    KillMode=process
    KillSignal=SIGINT
    Restart=on-failure
    RestartSec=42
    TimeoutStopSec=30
    StartLimitInterval=60
    StartLimitBurst=3
    LimitMEMLOCK=infinity
    [Install]
    WantedBy=multi-user.target
  permissions: '0644'
  defer: true
